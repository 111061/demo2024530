<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEC事務管理系統 - 請求書作成</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
        .sidebar {
            min-height: 100vh;
        }
        .operation-buttons {
            display: flex;
            justify-content: space-around;
        }
        .btn-lg {
            font-size: 1.25rem;
            padding: .5rem 1rem;
        }
        .table th, .table td {
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-md-block bg-dark sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="employees.html" id="nav-employees">員工列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="partners.html" id="nav-partners">合作夥伴列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="Contract Management Screen.html" id="nav-Contract Management Screen">契約管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="Invoice Creation Screen.html" id="nav-Invoice Creation Screen">請求書作成</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="Purchase Order Creation Screen.html" id="nav-Purchase Order Creation Screen">注文書作成</a>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="col-md-10 ml-sm-auto col-lg-10 pt-3 px-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h2">請求書管理</h1>
                <div class="email-authentication-form d-flex align-items-center">
                    <div class="me-2">
                        <label for="email-account" class="visually-hidden">郵件帳號</label>
                        <input type="email" class="form-control" id="email-account" placeholder="name@example.com">
                    </div>
                    <div class="me-2">
                        <label for="email-password" class="visually-hidden">密碼</label>
                        <input type="password" class="form-control" id="email-password" placeholder="Password">
                    </div>
                    <button class="btn btn-primary">登入</button>
                </div>
            </div>
            <div id="content">
                <!-- 請求書列表內容 -->
            </div>
        </main>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        function fetchInvoice_creations() {
            $.ajax({
                url: '/api/invoice_creations/test',
                type: 'GET',
                dataType: 'json',
                success: function(invoice_creations) {
                    var invoice_creationsContent = '<h2>請求書列表</h2>';
                    invoice_creationsContent += '<div id="add-invoice_creation-form" style="margin-bottom: 15px;">';
                    invoice_creationsContent += '<input type="text" id="parent-company" placeholder="上位会社">';
                    invoice_creationsContent += '<input type="text" id="order-number" placeholder="注文番号">';
                    invoice_creationsContent += '<input type="text" id="engineer" placeholder="エンジニア">';
                    invoice_creationsContent += '<input type="text" id="work_time" placeholder="出勤時間">';
                    invoice_creationsContent += '<input type="text" id="project_name" placeholder="プロジェクト名">';
                    invoice_creationsContent += '<input type="text" id="parent_sales" placeholder="上位営業">';
                    invoice_creationsContent += '<input type="text" id="unit_price" placeholder="単価">';
                    invoice_creationsContent += '<input type="text" id="payment_terms" placeholder="支払サイト">';
                    invoice_creationsContent += '<input type="text" id="settlement" placeholder="精算">';
                    invoice_creationsContent += '<input type="text" id="settlement_lower_limit" placeholder="生産下限">';
                    invoice_creationsContent += '<input type="text" id="settlement_upper_limit" placeholder="生産上限">';
                    invoice_creationsContent += '<input type="text" id="overtime_unit_price" placeholder="超過単価">';
                    invoice_creationsContent += '<input type="text" id="deduction_unit_price_total" placeholder="控除単価">';
                    invoice_creationsContent += '<input type="text" id="settlement_time_unit" placeholder="生産時間単位">';
                    invoice_creationsContent += '<input type="text" id="daily_rate_setting" placeholder="日割設定">';
                    invoice_creationsContent += '<input type="text" id="entry_date" placeholder="入場日">';
                    invoice_creationsContent += '<input type="text" id="expected_exit_date" placeholder="退場予定日">';
                    invoice_creationsContent += '<button id="add-invoice_creation-btn" class="btn btn-primary">新增請求書</button>';
                    invoice_creationsContent += '</div>';
                    invoice_creationsContent += '<table class="table">';
                    invoice_creationsContent += '<thead><tr><th><input type="checkbox" id="select-all-invoice_creations"></th><th>公司ID</th><th>公司名稱</th><th>銷售代表</th><th>郵箱</th><th>操作</th><th>上位会社</th><th>注文番号</th><th>エンジニア</th><th>出勤時間</th><th>プロジェクト名</th><th>上位営業</th><th>単価</th><th>支払サイト</th><th>精算</th><th>精算下限</th><th>生産上限</th><th>超過単価</th><th>控除単価</th><th>精算時間単位</th><th>日割設定</th><th>入場日</th><th>退場予定日</th></tr></thead><tbody>';
                    $.each(invoice_creations, function(index, invoice_creation) {
                        invoice_creationsContent += '<tr><td><input type="checkbox" class="invoice_creation-checkbox" data-email="' + invoice_creation.mail + '"></td><td>' + invoice_creation.comId + '</td><td>' + invoice_creation.company + '</td><td>' + invoice_creation.salesRep + '</td><td>' + invoice_creation.mail + '</td>';
                        invoice_creationsContent += '<td class="operation-buttons"><button class="btn btn-info btn-sm">變更</button></td></tr>';
                    });

                    invoice_creationsContent += '</tbody></table>';
                    invoice_creationsContent += '<div id="send-mail-to-invoice_creations-form" style="margin-top: 15px;">';
                    invoice_creationsContent += '<h3>發送郵件給合作夥伴</h3>';
                    invoice_creationsContent += '<input type="text" id="invoice_creation-mail-subject" placeholder="主題" class="form-control">';
                    invoice_creationsContent += '<textarea id="invoice_creation-mail-body" placeholder="內容" class="form-control" rows="4"></textarea>';
                    invoice_creationsContent += '<button id="delete-selected-invoice_creations" class="btn btn-danger btn-sm mt-2 me-2" style="display:none;">刪除選定</button>';
                    invoice_creationsContent += '<button id="send-mail-to-invoice_creations-btn" class="btn btn-secondary btn-sm mt-2" style="display:none;">發送郵件</button>';
                    invoice_creationsContent += '</div>';

                    $('#content').html(invoice_creationsContent);
                    $('#delete-selected-invoice_creations, #send-mail-to-invoice_creations-btn').hide();
                    $('#select-all-invoice_creations').prop('checked', false);
                },
                error: function(request, status, error) {
                    $('#content').html('<p>无法加载請求書数据。错误信息：' + request.responseText + '</p>');
                }
            });
        }

        fetchInvoice_creations();

        $(document).on('click', '#add-invoice_creation-btn', function() {
            var invoice_creationData = {
                parent_company: $('#parent-company').val(),
                order_number: $('#order-number').val(),
                engineer: $('#engineer').val(),
                work_time: $('#work_time').val(),
                project_name: $('#project_name').val(),
                parent_sales: $('#parent_sales').val(),
                unit_price: $('#unit_price').val(),
                payment_terms: $('#payment_terms').val(),
                settlement: $('#settlement').val(),
                settlement_lower_limit: $('#settlement_lower_limit').val(),
                settlement_upper_limit: $('#settlement_upper_limit').val(),
                overtime_unit_price: $('#overtime_unit_price').val(),
                deduction_unit_price_total: $('#deduction_unit_price_total').val(),
                settlement_time_unit: $('#settlement_time_unit').val(),
                daily_rate_setting: $('#daily_rate_setting').val(),
                entry_date: $('#entry_date').val(),
                expected_exit_date: $('#expected_exit_date').val(),
            };
            if (!invoice_creationData.parent_company || !invoice_creationData.order_number || !invoice_creationData.engineer || !invoice_creationData.work_time || !invoice_creationData.project_name || !invoice_creationData.parent_sales || !invoice_creationData.unit_price || !invoice_creationData.payment_terms || !invoice_creationData.settlement || !invoice_creationData.settlement_lower_limit || !invoice_creationData.settlement_upper_limit || !invoice_creationData.overtime_unit_price || !invoice_creationData.deduction_unit_price_total || !invoice_creationData.settlement_time_unit || !invoice_creationData.daily_rate_setting || !invoice_creationData.entry_date || !invoice_creationData.expected_exit_date) {
                alert('新增請求書失敗！所有欄位都必須填寫。');
                return;
            }

            $.ajax({
                url: '/api/invoice_creations/add',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(invoice_creationData),
                success: function(data) {
                    alert('請求書新增成功！');
                    fetchInvoice_creations();
                },
                error: function(error) {
                    alert('新增請求書失敗！');
                }
            });
        });

        $(document).on('click', '#select-all-invoice_creations', function() {
            $('.invoice_creation-checkbox').prop('checked', this.checked).trigger('change');
        });

        $(document).on('change', '.invoice_creation-checkbox', function() {
            var anyChecked = $('.invoice_creation-checkbox:checked').length > 0;
            $('#delete-selected-invoice_creations, #send-mail-to-invoice_creations-btn').toggle(anyChecked);
        });

        $(document).on('click', '#delete-selected-invoice_creations', function() {
            var selectedCheckboxes = $('.invoice_creation-checkbox:checked');
            var selectedIds = [];
            selectedCheckboxes.each(function() {
                var invoice_creationCode = $(this).closest('tr').find('td:eq(1)').text();
                selectedIds.push(invoice_creationCode);
            });
            var confirmation = confirm("确定要批量删除所选契约吗？");
            if (confirmation) {
                $.ajax({
                    url: '/api/invoice_creations/delete',
                    type: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify(selectedIds),
                    success: function(response) {
                        alert('删除成功');
                        fetchInvoice_creations();
                    },
                    error: function(xhr, status, error) {
                        alert('删除失败');
                    }
                });
            } else {
                alert('已取消');
            }
            $('.invoice_creation-checkbox:checked').prop('checked', false).trigger('change');
        });

        $(document).on('click', '#send-mail-to-invoice_creations-btn', function() {
            var mailSubject = $('#invoice_creation-mail-subject').val();
            var mailBody = $('#invoice_creation-mail-body').val();
            var mailAccount = $('#email-account').val();
            var mailPassword = $('#email-password').val();
            var selectedEmails = $('.invoice_creation-checkbox:checked').map(function() {
                return $(this).data('email');
            }).get();

            alert('发送邮件给合作夥伴:\n主题: ' + mailSubject + '\n内容: ' + mailBody + '\n帐号: ' + mailAccount + '\n密码: ' + mailPassword + '\n收件人邮箱: ' + selectedEmails);

            var emailDetails = {
                emails: selectedEmails,
                subject: mailSubject,
                content: mailBody,
                account: mailAccount,
                password: mailPassword
            };

            $.ajax({
                url: '/api/invoice_creations/sendEmails',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(emailDetails),
                success: function(data) {
                    console.log(data);
                    alert('邮件发送成功！');
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert('邮件发送失败！');
                }
            });
        });
    });
</script>

</body>
</html>
